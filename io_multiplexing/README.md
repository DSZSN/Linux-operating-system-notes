# I/O多路复用

服务器编程模型, 客户端发来的请求服务器会产生一个进程来对其进行服务,每一个客户请求就产生一个进程来服务,然而进程不可能无限制的产生,因此为了解决大量客户端访问的问题,引入了I/O复用技术(一个进程可以同时对多个客户请求进行服务)。


IO复用的"介质"是进程(select、poll、epool,进程需要调用select、pool或epool来实现)，复用一个进程来对多个IO进行服务,虽然客户端发来的IO是并发的,但是IO所需的读写数据多数情况下是没有准备好的,因此就可以利用一个函数(select、poll或Epool)来监听IO所需的这些数据的状态,一旦IO有数据可以进行读写了,进程就来对这样的IO进行服务。


IO多路复用指内核一旦发现进程指定的一个或多个I/O条件准备读取,它就通知该进程。


## I/O多路复用适用场景

1. 当客户端处理多个描述符时(交互式输入和网络套接字),必须使用I/O复用。
2. 当客户端同时处理多个套接字时,而这种情况是可能的,但很少出现。
3. 如果TCP服务器既要监听套接字,又要处理已建立连接套接字,一般要用到I/O复用.
4. 如果服务器既要处理TCP,又要处理UDP,一般要使用I/O复用。
5. 如果服务器要处理多个服务或者多个协议,一般要使用I/O复用。

## 多进程/多线程 Vs. IO多路复用

I/O多路复用与多进程/多线程技术相比,I/O多路复用技术的最大优势是系统开销小,系统不必创建进程/线程,也不必维护这些进程/线程,从而大大减小了系统的开销。


## Select Vs. Poll Vs. Epoll

### Select模型

* 并发限制: 一个进程所打开的FD(文件描述符)是有限制的,由FD_SETSIZE设置,默认值为1024。可以修改默认值,但性能会线性下降。
* 效率问题: select 每次调用都会线性扫描全部的FD集合,这样效率就会呈现线性下降,把FD_SETSIZE改大后性能下降。
* 内存拷贝: 内核/用户空间内存拷贝问题,如何让内核把FD消息通知给用户空间？Select模型采用了内存拷贝方法。

### Poll模型
Poll是Select的改进版,将FD_SET改造成节点组成的链表,取消了最大1024并发限制,其它并无大的区别,当FD多时,同样会造成效率下降。

### Epoll模型

* Epoll没有最大并发连接的限制,上限是最大可以打开的文件数目。这个数目和系统内存关系很大,具体数组可以cat /proc/sys/fs/file-max查看。
* 效率提升,Epoll最大优点就是它是事务触发,只处理"活跃"连接,无需轮训整个链表。在实际的网络环境中,Epoll的效率高于Select和Poll。
* Epoll采用用户/内核内存空间共享方式,无需进行内存拷贝。相比Select和Poll两种方式内存拷贝提升性能。


### 总结
Select是采用内核轮训方式,每次调用都需要轮训FD_SET;Poll是select的改进版,由FD_SET改造成链表,取消了最大1024并发限制;Epoll将轮询机制改造为事例触发机制,给每一个fd附上一个callback,当监听事件发生时,就将FD链接到就绪链表。调用Epoll_Wait时,只用检查就绪链表就可以,而不需要像select和poll一样进行轮询。

Select和Poll将存在fd的结构或者数组每次调用时都复制到内核态,然后调用完再复制回用户态。Epoll使用内存映射,省去了这部分的data-copy操作。


